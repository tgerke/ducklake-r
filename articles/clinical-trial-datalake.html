<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Clinical Trial Data Lake with ducklake • ducklake</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Clinical Trial Data Lake with ducklake">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ducklake</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/ducklake.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ducklake.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Use Cases</h6></li>
    <li><a class="dropdown-item" href="../articles/clinical-trial-datalake.html">Clinical Trial Data Lake</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Core Operations</h6></li>
    <li><a class="dropdown-item" href="../articles/modifying-tables.html">Modifying Tables</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced Features</h6></li>
    <li><a class="dropdown-item" href="../articles/transactions.html">Working with Transactions</a></li>
    <li><a class="dropdown-item" href="../articles/time-travel.html">Time Travel Queries</a></li>
    <li><a class="dropdown-item" href="../articles/storage-and-backups.html">Storage and Backup Management</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tgerke/ducklake-r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="clinical-trial-datalake_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="clinical-trial-datalake_files/d3-3.3.8/d3.min.js"></script><script src="clinical-trial-datalake_files/dagre-0.4.0/dagre-d3.min.js"></script><link href="clinical-trial-datalake_files/mermaid-0.3.0/dist/mermaid.css" rel="stylesheet">
<script src="clinical-trial-datalake_files/mermaid-0.3.0/dist/mermaid.slim.min.js"></script><link href="clinical-trial-datalake_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="clinical-trial-datalake_files/chromatography-0.1/chromatography.js"></script><script src="clinical-trial-datalake_files/DiagrammeR-binding-1.0.11/DiagrammeR.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Clinical Trial Data Lake with ducklake</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tgerke/ducklake-r/blob/main/vignettes/clinical-trial-datalake.Rmd" class="external-link"><code>vignettes/clinical-trial-datalake.Rmd</code></a></small>
      <div class="d-none name"><code>clinical-trial-datalake.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tgerke.github.io/ducklake-r/">ducklake</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>While Electronic Data Capture (EDC) systems provide built-in logging
and audit trails for collected clinical trial data, significant data
management challenges emerge once data is exported from the EDC for
statistical programming and analysis. Once SDTM datasets are created and
analysis begins, traditional file-based approaches often result in:</p>
<ul>
<li>
<strong>Disconnected Flat Files</strong>: CDISC datasets are
inherently relational (linked by <code>USUBJID</code>, domain keys) but
are typically stored as separate XPT/CSV files or isolated SAS datasets,
often requiring manual loading and joining for cross-domain
analyses</li>
<li>
<strong>Loss of Audit Trail</strong>: EDC protections disappear;
tracking changes to derived datasets becomes manual</li>
<li>
<strong>Version Control Challenges</strong>: Multiple versions of
analysis datasets scattered across folders and drives</li>
<li>
<strong>Data Lineage Issues</strong>: Unclear provenance of derived
variables and ADaM datasets</li>
<li>
<strong>Reproducibility Concerns</strong>: Inability to recreate
analyses from specific time points</li>
<li>
<strong>Collaboration Friction</strong>: Multiple statistical
programmers working with different versions of data</li>
<li>
<strong>Regulatory Gaps</strong>: Difficulty demonstrating 21 CFR
Part 11 compliance for derived datasets</li>
</ul>
<p>The <a href="https://tgerke.github.io/ducklake-r/">ducklake</a>
package addresses these post-EDC challenges by implementing a versioned
data lake architecture specifically designed for statistical programming
workflows in R. Rather than managing disconnected flat files, <a href="https://ducklake.select/" class="external-link">DuckLake</a> provides a modern
relational database structure that preserves the inherent relationships
between CDISC datasets while adding enterprise-grade version control. By
storing SDTM (Study Data Tabulation Model) and ADaM (Analysis Data
Model) datasets along with regulatory submission artifacts (define.xml,
ARD, ARM, specifications) in a DuckLake, statistical programmers
gain:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Relational Data Model</strong>: CDISC datasets are
inherently relational with explicit keys (<code>USUBJID</code>, domain
relationships) but traditionally stored as disconnected flat files (XPT,
CSV). DuckLake preserves the relational structure, enabling efficient
joins and queries across domains without loading multiple files</li>
<li>
<strong>Modern Data Architecture</strong>: Move from file-based to
database-backed workflows while maintaining R’s familiar data frame
interface</li>
<li>
<strong>Automatic Versioning</strong>: Every data modification is
tracked with timestamps and metadata</li>
<li>
<strong>Time Travel</strong>: Query data as it existed at any point
in time</li>
<li>
<strong>Audit Trail</strong>: Complete history of data changes for
regulatory compliance</li>
<li>
<strong>Reproducibility</strong>: Recreate analyses exactly as they
were run previously</li>
<li>
<strong>Collaboration</strong>: Multiple analysts can work safely
with shared data</li>
<li>
<strong>Performance</strong>: Fast queries on large datasets using
DuckDB’s columnar storage and query optimization</li>
<li>
<strong>Transactions</strong>: Atomic updates ensure data
consistency across related datasets</li>
<li>
<strong>Unified Storage</strong>: Keep datasets alongside regulatory
artifacts (define.xml, ARD, ARM) in one versioned repository</li>
</ol>
<p>This vignette demonstrates how to set up a clinical trial data lake,
starting with SDTM domains and building through to analysis-ready ADaM
datasets, including storage of regulatory submission artifacts.</p>
</div>
<div class="section level2">
<h2 id="setting-up-the-data-lake">Setting Up the Data Lake<a class="anchor" aria-label="anchor" href="#setting-up-the-data-lake"></a>
</h2>
<p>First, we’ll create a new DuckLake to store our clinical trial data.
This establishes the foundational infrastructure for our versioned data
repository.</p>
<p>We’ll use a temporary directory for this vignette, but in practice
you would specify a permanent location using the <code>lake_path</code>
argument (e.g., a shared network drive or project directory).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install the ducklake extension to duckdb (required once per system)</span></span>
<span><span class="fu"><a href="../reference/install_ducklake.html">install_ducklake</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define where to create a new data lake or access an existing one</span></span>
<span><span class="co"># For this vignette, we use vignette_temp_dir; in practice, use a permanent location</span></span>
<span><span class="co"># lake_path &lt;- "/path/to/your/project/data_lake"</span></span>
<span><span class="va">trial_lake_path</span> <span class="op">&lt;-</span> <span class="va">vignette_temp_dir</span></span>
<span></span>
<span><span class="co"># attach_ducklake creates or attaches (if it already exists) a data lake</span></span>
<span><span class="fu"><a href="../reference/attach_ducklake.html">attach_ducklake</a></span><span class="op">(</span></span>
<span>  ducklake_name <span class="op">=</span> <span class="st">"clinical_trial_lake"</span>,</span>
<span>  lake_path <span class="op">=</span> <span class="va">trial_lake_path</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify the lake was created</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">trial_lake_path</span>, pattern <span class="op">=</span> <span class="st">"clinical_trial_lake"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "clinical_trial_lake.ducklake"     "clinical_trial_lake.ducklake.wal"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-lake-architecture-medallion-layers">Data Lake Architecture: Medallion Layers<a class="anchor" aria-label="anchor" href="#data-lake-architecture-medallion-layers"></a>
</h2>
<p>Before loading data, it’s important to understand the layered
architecture we’ll use. This follows the <strong>medallion
architecture</strong> pattern common in modern data lakes:</p>
<ul>
<li>
<strong>Bronze Layer (Raw)</strong>: Data exactly as received from
source systems, with no transformations. This preserves the original
data for audit trails and reprocessing.</li>
<li>
<strong>Silver Layer (Cleaned)</strong>: Standardized and cleaned
data with transformations like <code><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/convert_blanks_to_na.html">convert_blanks_to_na()</a></code>, type
conversions, and validation. This is the trusted source for deriving
analysis datasets.</li>
<li>
<strong>Gold Layer (Analytics)</strong>: Business-logic datasets
optimized for specific analyses, such as ADaM datasets. This is where
analysis happens.</li>
</ul>
<p>This approach provides:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Complete Audit Trail</strong>: Original data is preserved
alongside transformations</li>
<li>
<strong>Reprocessability</strong>: If cleaning logic changes,
reprocess from bronze without re-extracting</li>
<li>
<strong>Data Lineage</strong>: Clear progression from raw → cleaned
→ analysis-ready</li>
<li>
<strong>Validation</strong>: Compare layers to verify
transformations</li>
<li>
<strong>Regulatory Compliance</strong>: Demonstrate no source data
was lost or improperly altered</li>
</ol>
<div id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:100%;height:200px;" class="DiagrammeR html-widget"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"diagram":"\n  graph LR\n    A[Bronze Layer<br/>Raw Data<br/>dm_raw, ae_raw, ...] --> B[Silver Layer<br/>Cleaned Data<br/>dm, ae, ...]\n    B --> C[Gold Layer<br/>Analysis Data<br/>adsl, adae, ...]\n    \n    style A fill:#cd7f32,stroke:#8b4513,stroke-width:2px,color:#fff\n    style B fill:#c0c0c0,stroke:#808080,stroke-width:2px,color:#000\n    style C fill:#ffd700,stroke:#daa520,stroke-width:2px,color:#000\n  "},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level2">
<h2 id="loading-sdtm-domains">Loading SDTM Domains<a class="anchor" aria-label="anchor" href="#loading-sdtm-domains"></a>
</h2>
<p>SDTM datasets form the foundation of clinical trial data. We’ll load
several key domains from the <a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaverse SDTM
collection</a>, which contains realistic test data from the CDISC pilot
study.</p>
<p>For each domain, we’ll: 1. Load raw data into the <strong>bronze
layer</strong> (as received) 2. Apply cleaning transformations to create
the <strong>silver layer</strong> (analysis-ready)</p>
<div class="section level3">
<h3 id="demographics-dm">Demographics (DM)<a class="anchor" aria-label="anchor" href="#demographics-dm"></a>
</h3>
<p>The Demographics domain contains baseline characteristics for each
subject.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bronze layer: Load raw SDTM Demographics exactly as received</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/dm.html" class="external-link">dm</a></span>, <span class="st">"dm_raw"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add raw demographics"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Silver layer: Apply cleaning transformations</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"dm_raw"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">admiral</span><span class="fu">::</span><span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="st">"dm"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Clean demographics data"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Verify the cleaned table</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"dm"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AGE</span>, <span class="va">SEX</span>, <span class="va">RACE</span>, <span class="va">ARM</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 5]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;   USUBJID       AGE SEX   RACE  ARM                 </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 01-701-1015    63 F     WHITE Placebo             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 01-701-1023    64 M     WHITE Placebo             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 01-701-1028    71 M     WHITE Xanomeline High Dose</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 01-701-1033    74 M     WHITE Xanomeline Low Dose </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 01-701-1034    77 F     WHITE Xanomeline High Dose</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 01-701-1047    85 F     WHITE Placebo</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="supplemental-demographics-suppdm">Supplemental Demographics (SUPPDM)<a class="anchor" aria-label="anchor" href="#supplemental-demographics-suppdm"></a>
</h3>
<p>Supplemental domains contain additional variables not in the parent
domain.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bronze layer: Raw data</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/suppdm.html" class="external-link">suppdm</a></span>, <span class="st">"suppdm_raw"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add raw supplemental demographics"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Silver layer: Cleaned data</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"suppdm_raw"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">admiral</span><span class="fu">::</span><span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="st">"suppdm"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Clean supplemental demographics"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="disposition-ds">Disposition (DS)<a class="anchor" aria-label="anchor" href="#disposition-ds"></a>
</h3>
<p>The Disposition domain tracks subject progress through the study.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bronze layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ds.html" class="external-link">ds</a></span>, <span class="st">"ds_raw"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add raw disposition"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Silver layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ds_raw"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">admiral</span><span class="fu">::</span><span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="st">"ds"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Clean disposition data"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exposure-ex">Exposure (EX)<a class="anchor" aria-label="anchor" href="#exposure-ex"></a>
</h3>
<p>The Exposure domain contains treatment administration records.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bronze layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ex.html" class="external-link">ex</a></span>, <span class="st">"ex_raw"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add raw exposure"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Silver layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ex_raw"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">admiral</span><span class="fu">::</span><span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="st">"ex"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Clean exposure data"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adverse-events-ae">Adverse Events (AE)<a class="anchor" aria-label="anchor" href="#adverse-events-ae"></a>
</h3>
<p>The Adverse Events domain records safety data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bronze layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/ae.html" class="external-link">ae</a></span>, <span class="st">"ae_raw"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add raw adverse events"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Silver layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="va">ae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ae_raw"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">admiral</span><span class="fu">::</span><span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="st">"ae"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Clean adverse events"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="vital-signs-vs">Vital Signs (VS)<a class="anchor" aria-label="anchor" href="#vital-signs-vs"></a>
</h3>
<p>Vital Signs data will be used for deriving baseline values.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bronze layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/vs.html" class="external-link">vs</a></span>, <span class="st">"vs_raw"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add raw vital signs"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Silver layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"vs_raw"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">admiral</span><span class="fu">::</span><span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="st">"vs"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Clean vital signs"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pharmacokinetic-concentrations-pc">Pharmacokinetic Concentrations (PC)<a class="anchor" aria-label="anchor" href="#pharmacokinetic-concentrations-pc"></a>
</h3>
<p>For PK analysis, we’ll also load concentration data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Bronze layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="fu">pharmaversesdtm</span><span class="fu">::</span><span class="va"><a href="https://pharmaverse.github.io/pharmaversesdtm/reference/pc.html" class="external-link">pc</a></span>, <span class="st">"pc_raw"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add raw PK concentrations"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Silver layer</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"pc_raw"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">admiral</span><span class="fu">::</span><span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/convert_blanks_to_na.html">convert_blanks_to_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="st">"pc"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Clean PK concentrations"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="verifying-sdtm-version-control">Verifying SDTM Version Control<a class="anchor" aria-label="anchor" href="#verifying-sdtm-version-control"></a>
</h3>
<p>Let’s verify that our SDTM data in the bronze and silver layers is
indeed versioned. Each <code><a href="../reference/create_table.html">create_table()</a></code> call within a
transaction automatically creates a snapshot with metadata.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View the first 5 of all snapshots in the data lake</span></span>
<span><span class="fu"><a href="../reference/list_table_snapshots.html">list_table_snapshots</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;   snapshot_id       snapshot_time schema_version</span></span>
<span><span class="co">#&gt; 1           0 2026-02-09 21:16:40              0</span></span>
<span><span class="co">#&gt; 2           1 2026-02-09 21:16:40              1</span></span>
<span><span class="co">#&gt; 3           2 2026-02-09 21:16:40              2</span></span>
<span><span class="co">#&gt; 4           3 2026-02-09 21:16:40              3</span></span>
<span><span class="co">#&gt; 5           4 2026-02-09 21:16:40              4</span></span>
<span><span class="co">#&gt;                                                    changes  author</span></span>
<span><span class="co">#&gt; 1                                    schemas_created, main    &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2     tables_created, tables_inserted_into, main.dm_raw, 1 T Gerke</span></span>
<span><span class="co">#&gt; 3         tables_created, tables_inserted_into, main.dm, 2 T Gerke</span></span>
<span><span class="co">#&gt; 4 tables_created, tables_inserted_into, main.suppdm_raw, 3 T Gerke</span></span>
<span><span class="co">#&gt; 5     tables_created, tables_inserted_into, main.suppdm, 4 T Gerke</span></span>
<span><span class="co">#&gt;                      commit_message commit_extra_info</span></span>
<span><span class="co">#&gt; 1                              &lt;NA&gt;              &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2              Add raw demographics              &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3           Clean demographics data              &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4 Add raw supplemental demographics              &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5   Clean supplemental demographics              &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Filter snapshots for specific tables</span></span>
<span><span class="fu"><a href="../reference/list_table_snapshots.html">list_table_snapshots</a></span><span class="op">(</span><span class="st">"dm_raw"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   snapshot_id       snapshot_time schema_version</span></span>
<span><span class="co">#&gt; 2           1 2026-02-09 21:16:40              1</span></span>
<span><span class="co">#&gt;                                                changes  author</span></span>
<span><span class="co">#&gt; 2 tables_created, tables_inserted_into, main.dm_raw, 1 T Gerke</span></span>
<span><span class="co">#&gt;         commit_message commit_extra_info</span></span>
<span><span class="co">#&gt; 2 Add raw demographics              &lt;NA&gt;</span></span>
<span><span class="fu"><a href="../reference/list_table_snapshots.html">list_table_snapshots</a></span><span class="op">(</span><span class="st">"dm"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   snapshot_id       snapshot_time schema_version</span></span>
<span><span class="co">#&gt; 3           2 2026-02-09 21:16:40              2</span></span>
<span><span class="co">#&gt;                                            changes  author</span></span>
<span><span class="co">#&gt; 3 tables_created, tables_inserted_into, main.dm, 2 T Gerke</span></span>
<span><span class="co">#&gt;            commit_message commit_extra_info</span></span>
<span><span class="co">#&gt; 3 Clean demographics data              &lt;NA&gt;</span></span></code></pre></div>
<p>This demonstrates that:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Every table creation is versioned</strong> - Both bronze
(<code>dm_raw</code>) and silver (<code>dm</code>) layers have version
1.0</li>
<li>
<strong>Metadata is captured</strong> - Each snapshot includes
timestamp and table information</li>
<li>
<strong>Time travel works</strong> - We can retrieve any specific
version using <code><a href="../reference/get_ducklake_table_version.html">get_ducklake_table_version()</a></code>
</li>
<li>
<strong>Audit trail exists</strong> - Complete history is maintained
for regulatory compliance</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="building-the-analytics-layer-adam-datasets-gold-layer">Building the Analytics Layer: ADaM Datasets (Gold Layer)<a class="anchor" aria-label="anchor" href="#building-the-analytics-layer-adam-datasets-gold-layer"></a>
</h2>
<p>Now that our SDTM data is loaded and versioned in the <strong>silver
layer</strong>, we’ll create analysis datasets following ADaM standards
for the <strong>gold layer</strong>. These datasets apply business logic
and derivations optimized for specific analyses. Each dataset will be
stored in the data lake with full version control.</p>
<p>The gold layer reads from the silver layer (cleaned SDTM), ensuring
all analysis datasets are built from trusted, standardized source
data.</p>
<div class="section level3">
<h3 id="adsl-subject-level-analysis-dataset">ADSL: Subject-Level Analysis Dataset<a class="anchor" aria-label="anchor" href="#adsl-subject-level-analysis-dataset"></a>
</h3>
<p>ADSL is the fundamental ADaM dataset containing one record per
subject with key analysis variables.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read SDTM data from the lake and collect into memory</span></span>
<span><span class="co"># Admiral functions require tibbles/data.frames, not lazy database connections</span></span>
<span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"dm"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">suppdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"suppdm"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ds"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ex"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ae"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"vs"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine DM and SUPPDM</span></span>
<span><span class="va">dm_suppdm</span> <span class="op">&lt;-</span> <span class="va">dm</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">suppdm</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">QNAM</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"EDUCLVL"</span>, <span class="st">"DISCONFL"</span>, <span class="st">"DSRAEFL"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span></span>
<span>        id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>        names_from <span class="op">=</span> <span class="va">QNAM</span>,</span>
<span>        values_from <span class="op">=</span> <span class="va">QVAL</span></span>
<span>      <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"STUDYID"</span>, <span class="st">"USUBJID"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive treatment dates and durations</span></span>
<span><span class="va">ex_ext</span> <span class="op">&lt;-</span> <span class="va">ex</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">EXSTDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"EXST"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">EXENDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"EXEN"</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"last"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive disposition variables first (needed for later derivations)</span></span>
<span><span class="va">ds_ext</span> <span class="op">&lt;-</span> <span class="va">ds</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">DSSTDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"DSST"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Build ADSL with all derivations in a single pipeline</span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="va">dm_suppdm</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Treatment Start Datetime</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_ext</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">EXTRT</span>, <span class="st">"PLACEBO"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                 <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXSTDTM</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span>TRTSDTM <span class="op">=</span> <span class="va">EXSTDTM</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">EXSTDTM</span>, <span class="va">EXSEQ</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"first"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Treatment End Datetime</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex_ext</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">EXTRT</span>, <span class="st">"PLACEBO"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                 <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EXENDTM</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span>TRTEDTM <span class="op">=</span> <span class="va">EXENDTM</span><span class="op">)</span>,</span>
<span>    order <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">EXENDTM</span>, <span class="va">EXSEQ</span><span class="op">)</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"last"</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Convert to dates</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span>source_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">TRTSDTM</span>, <span class="va">TRTEDTM</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Treatment duration</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_var_trtdurd.html">derive_var_trtdurd</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Safety population flag</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_var_merged_exist_flag.html">derive_var_merged_exist_flag</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ex</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_var <span class="op">=</span> <span class="va">SAFFL</span>,</span>
<span>    condition <span class="op">=</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">|</span> <span class="op">(</span><span class="va">EXDOSE</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">EXTRT</span>, <span class="st">"PLACEBO"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Treatment variables</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    TRT01P <span class="op">=</span> <span class="va">ARM</span>,</span>
<span>    TRT01A <span class="op">=</span> <span class="va">ACTARM</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Age groups</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AGEGR1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">18</span> <span class="op">~</span> <span class="st">"&lt;18"</span>,</span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">AGE</span>, <span class="fl">18</span>, <span class="fl">64</span><span class="op">)</span> <span class="op">~</span> <span class="st">"18-64"</span>,</span>
<span>      <span class="va">AGE</span> <span class="op">&gt;</span> <span class="fl">64</span> <span class="op">~</span> <span class="st">"&gt;64"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Missing"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    AGEGR1N <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">18</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">AGE</span>, <span class="fl">18</span>, <span class="fl">64</span><span class="op">)</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="va">AGE</span> <span class="op">&gt;</span> <span class="fl">64</span> <span class="op">~</span> <span class="fl">3</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">4</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Randomization date</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ds_ext</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span>RANDDT <span class="op">=</span> <span class="va">DSSTDT</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">DSDECOD</span> <span class="op">==</span> <span class="st">"RANDOMIZED"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># End of study date</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">ds_ext</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span>EOSDT <span class="op">=</span> <span class="va">DSSTDT</span><span class="op">)</span>,</span>
<span>    filter_add <span class="op">=</span> <span class="va">DSCAT</span> <span class="op">==</span> <span class="st">"DISPOSITION EVENT"</span> <span class="op">&amp;</span> <span class="va">DSDECOD</span> <span class="op">!=</span> <span class="st">"SCREEN FAILURE"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># End of study status</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    EOSSTT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">EOSDT</span><span class="op">)</span> <span class="op">~</span> <span class="st">"ONGOING"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"COMPLETED"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Store ADSL in the data lake</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="va">adsl</span>, <span class="st">"adsl"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Create ADSL dataset"</span>,</span>
<span>  commit_extra_info <span class="op">=</span> <span class="st">"Derived from DM, SUPPDM, DS, EX; includes treatment dates, safety flags, age groups"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Preview ADSL</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AGE</span>, <span class="va">AGEGR1</span>, <span class="va">TRT01P</span>, <span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">SAFFL</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 7]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;    USUBJID       AGE AGEGR1 TRT01P               TRTSDT     TRTEDT     SAFFL</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 01-701-1015    63 18-64  Placebo              2014-01-02 2014-07-02 Y    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 01-701-1023    64 18-64  Placebo              2012-08-05 2012-09-01 Y    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 01-701-1028    71 &gt;64    Xanomeline High Dose 2013-07-19 2014-01-14 Y    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 01-701-1033    74 &gt;64    Xanomeline Low Dose  2014-03-18 2014-03-31 Y    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 01-701-1034    77 &gt;64    Xanomeline High Dose 2014-07-01 2014-12-30 Y    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 01-701-1047    85 &gt;64    Placebo              2013-02-12 2013-03-09 Y    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 01-701-1057    59 18-64  Screen Failure       <span style="color: #BB0000;">NA</span>         <span style="color: #BB0000;">NA</span>         <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 01-701-1097    68 &gt;64    Xanomeline Low Dose  2014-01-01 2014-07-09 Y    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 01-701-1111    81 &gt;64    Xanomeline Low Dose  2012-09-07 2012-09-16 Y    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 01-701-1115    84 &gt;64    Xanomeline Low Dose  2012-11-30 2013-01-23 Y</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adae-adverse-events-analysis-dataset">ADAE: Adverse Events Analysis Dataset<a class="anchor" aria-label="anchor" href="#adae-adverse-events-analysis-dataset"></a>
</h3>
<p>ADAE provides analysis-ready adverse event data with
treatment-emergent flags and severity grades.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read ADSL for merging</span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ae"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build ADAE</span></span>
<span><span class="va">adae</span> <span class="op">&lt;-</span> <span class="va">ae</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Merge ADSL variables</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTEDT</span>, <span class="va">TRT01A</span>, <span class="va">TRT01P</span><span class="op">)</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Derive analysis dates</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">AESTDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dt.html">derive_vars_dt</a></span><span class="op">(</span></span>
<span>    dtc <span class="op">=</span> <span class="va">AEENDTC</span>,</span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AEN"</span>,</span>
<span>    date_imputation <span class="op">=</span> <span class="st">"last"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Derive treatment-emergent flag</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    TRTEMFL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ASTDT</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">TRTSDT</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">ASTDT</span> <span class="op">&gt;=</span> <span class="va">TRTSDT</span>,</span>
<span>      <span class="st">"Y"</span>,</span>
<span>      <span class="cn">NA_character_</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Derive analysis variables</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AOCCPFL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">AESEQ</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">AESEQ</span><span class="op">)</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span>,</span>
<span>    AOCC01FL <span class="op">=</span> <span class="va">AOCCPFL</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AEDECOD</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    AOCC01FL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Y"</span>, <span class="cn">NA_character_</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Store ADAE in the data lake</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="va">adae</span>, <span class="st">"adae"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Create ADAE dataset"</span>,</span>
<span>  commit_extra_info <span class="op">=</span> <span class="st">"Includes treatment-emergent flags and occurrence flags"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Preview ADAE</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">TRTEMFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AEDECOD</span>, <span class="va">ASTDT</span>, <span class="va">AESEV</span>, <span class="va">TRTEMFL</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 5]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;    USUBJID     AEDECOD                              ASTDT      AESEV    TRTEMFL</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 01-701-1015 APPLICATION SITE ERYTHEMA            2014-01-03 MILD     Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 01-701-1015 APPLICATION SITE PRURITUS            2014-01-03 MILD     Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 01-701-1015 DIARRHOEA                            2014-01-09 MILD     Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 01-701-1023 ATRIOVENTRICULAR BLOCK SECOND DEGREE 2012-08-26 MILD     Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 01-701-1023 ERYTHEMA                             2012-08-07 MILD     Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 01-701-1023 ERYTHEMA                             2012-08-07 MODERATE Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 01-701-1023 ERYTHEMA                             2012-08-07 MILD     Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 01-701-1028 APPLICATION SITE ERYTHEMA            2013-07-21 MILD     Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 01-701-1028 APPLICATION SITE PRURITUS            2013-08-08 MILD     Y      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 01-701-1034 APPLICATION SITE PRURITUS            2014-08-27 MILD     Y</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adpc-pharmacokinetic-concentrations-analysis-dataset">ADPC: Pharmacokinetic Concentrations Analysis Dataset<a class="anchor" aria-label="anchor" href="#adpc-pharmacokinetic-concentrations-analysis-dataset"></a>
</h3>
<p>ADPC supports non-compartmental analysis by combining PK
concentrations with dosing records.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read required datasets</span></span>
<span><span class="va">adsl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"pc"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ex"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"vs"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get ADSL variables needed</span></span>
<span><span class="va">adsl_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">TRTSDT</span>, <span class="va">TRTSDTM</span>, <span class="va">TRT01P</span>, <span class="va">TRT01A</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derive PC dates and times</span></span>
<span><span class="va">pc_dates</span> <span class="op">&lt;-</span> <span class="va">pc</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">PCDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span>,</span>
<span>    ignore_seconds_flag <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dtm_to_tm.html">derive_vars_dtm_to_tm</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">ADTM</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dy.html">derive_vars_dy</a></span><span class="op">(</span>reference_date <span class="op">=</span> <span class="va">TRTSDT</span>, source_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">ADT</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    EVID <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    NFRLT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">PCTPTNUM</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">PCTPTNUM</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Process exposure records</span></span>
<span><span class="va">ex_dates</span> <span class="op">&lt;-</span> <span class="va">ex</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_merged.html">derive_vars_merged</a></span><span class="op">(</span></span>
<span>    dataset_add <span class="op">=</span> <span class="va">adsl</span>,</span>
<span>    new_vars <span class="op">=</span> <span class="va">adsl_vars</span>,</span>
<span>    by_vars <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">EXDOSE</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dtm.html">derive_vars_dtm</a></span><span class="op">(</span></span>
<span>    new_vars_prefix <span class="op">=</span> <span class="st">"AST"</span>,</span>
<span>    dtc <span class="op">=</span> <span class="va">EXSTDTC</span>,</span>
<span>    time_imputation <span class="op">=</span> <span class="st">"00:00:00"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    EVID <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    NFRLT <span class="op">=</span> <span class="fl">24</span> <span class="op">*</span> <span class="va">VISITDY</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https:/pharmaverse.github.io/admiral/v1.4.1/cran-release/reference/derive_vars_dtm_to_dt.html">derive_vars_dtm_to_dt</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/defusing-advanced.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">ASTDTM</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine PC and EX</span></span>
<span><span class="va">adpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pc_dates</span>, <span class="va">ex_dates</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">STUDYID</span>, <span class="va">USUBJID</span>, <span class="va">ADTM</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PARAMCD <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">PCTESTCD</span>, <span class="st">"DOSE"</span><span class="op">)</span>,</span>
<span>    AVAL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">EVID</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">EXDOSE</span>,</span>
<span>      <span class="va">PCSTRESC</span> <span class="op">==</span> <span class="st">"&lt;BLQ"</span> <span class="op">&amp;</span> <span class="va">NFRLT</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      <span class="va">PCSTRESC</span> <span class="op">==</span> <span class="st">"&lt;BLQ"</span> <span class="op">&amp;</span> <span class="va">NFRLT</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">PCLLOQ</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">PCSTRESN</span></span>
<span>    <span class="op">)</span>,</span>
<span>    PARAM <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"XAN"</span> <span class="op">~</span> <span class="st">"Xanomeline Concentration"</span>,</span>
<span>      <span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"DOSE"</span> <span class="op">~</span> <span class="st">"Xanomeline Dose"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Store ADPC in the data lake</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="va">adpc</span>, <span class="st">"adpc"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Create ADPC dataset"</span>,</span>
<span>  commit_extra_info <span class="op">=</span> <span class="st">"PK concentrations with dosing records for NCA"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Preview ADPC</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adpc"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"XAN"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">ADT</span>, <span class="va">PCTPT</span>, <span class="va">AVAL</span>, <span class="va">PARAM</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 5]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;    USUBJID     ADT        PCTPT             AVAL PARAM                   </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 01-701-1015 2014-01-01 Pre-dose         0     Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 01-701-1015 2014-01-02 5 Min Post-dose  0.005 Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 01-701-1015 2014-01-02 30 Min Post-dose 0.005 Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 01-701-1015 2014-01-02 1h Post-dose     0.005 Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 01-701-1015 2014-01-02 1.5h Post-dose   0.005 Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 01-701-1015 2014-01-02 2h Post-dose     0.005 Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 01-701-1015 2014-01-02 4h Post-dose     0.005 Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 01-701-1015 2014-01-02 6h Post-dose     0.005 Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 01-701-1015 2014-01-02 0-6h Post-dose   0.005 Xanomeline Concentration</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 01-701-1015 2014-01-02 8h Post-dose     0.005 Xanomeline Concentration</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="storing-regulatory-submission-artifacts">Storing Regulatory Submission Artifacts<a class="anchor" aria-label="anchor" href="#storing-regulatory-submission-artifacts"></a>
</h2>
<p>Beyond datasets, regulatory submissions require metadata and
documentation. The data lake can store various types of artifacts
including define.xml files and other structured data:</p>
<div class="section level3">
<h3 id="define-xml-metadata">Define.xml Metadata<a class="anchor" aria-label="anchor" href="#define-xml-metadata"></a>
</h3>
<p>The define.xml file provides dataset and variable-level metadata
required for regulatory submissions. Store it as a versioned
artifact:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Store define.xml content</span></span>
<span><span class="co"># In practice, you might read this from a file generated by your metadata system</span></span>
<span><span class="va">define_xml</span> <span class="op">&lt;-</span> <span class="st">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span>
<span><span class="st">&lt;ODM xmlns="http://www.cdisc.org/ns/odm/v1.3"&gt;</span></span>
<span><span class="st">  &lt;!-- Define.xml content for ADSL, ADAE, ADPC datasets --&gt;</span></span>
<span><span class="st">&lt;/ODM&gt;'</span></span>
<span></span>
<span><span class="co"># Create a table for regulatory documents</span></span>
<span><span class="va">regulatory_docs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  doc_type <span class="op">=</span> <span class="st">"define.xml"</span>,</span>
<span>  doc_version <span class="op">=</span> <span class="st">"1.0"</span>,</span>
<span>  content <span class="op">=</span> <span class="va">define_xml</span>,</span>
<span>  created_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Dataset and variable metadata for regulatory submission"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="va">regulatory_docs</span>, <span class="st">"regulatory_documents"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add define.xml metadata"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"regulatory_documents"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;regulatory_documents&gt; [?? x 5]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;   doc_type   doc_version content                        created_date description</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                          <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> define.xml 1.0         <span style="color: #949494;">"</span>&lt;?xml version=\"1.0\" encodi… 2026-02-09   Dataset an…</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="storing-different-data-types-json-example">Storing Different Data Types (JSON Example)<a class="anchor" aria-label="anchor" href="#storing-different-data-types-json-example"></a>
</h3>
<p>While Analysis Results Metadata (ARM) and Analysis Results Data (ARD)
might be stored as separate data tables in practice, this example
demonstrates how to store structured data in JSON format within the data
lake:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Store Analysis Results Metadata (ARM)</span></span>
<span><span class="va">arm_content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  analysis_id <span class="op">=</span> <span class="st">"DEMO01"</span>,</span>
<span>  analysis_name <span class="op">=</span> <span class="st">"Demographics Table"</span>,</span>
<span>  dataset_used <span class="op">=</span> <span class="st">"ADSL"</span>,</span>
<span>  program_name <span class="op">=</span> <span class="st">"t_demographics.R"</span>,</span>
<span>  output_file <span class="op">=</span> <span class="st">"t_demographics.rtf"</span>,</span>
<span>  analysis_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add to or update regulatory documents table</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"regulatory_documents"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>content <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">content</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>        doc_type <span class="op">=</span> <span class="st">"ARM"</span>,</span>
<span>        doc_version <span class="op">=</span> <span class="st">"1.0"</span>,</span>
<span>        content <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">arm_content</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        created_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        description <span class="op">=</span> <span class="st">"Analysis Results Metadata"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">doc_type</span>, <span class="va">doc_version</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"regulatory_documents"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add ARM metadata"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Example: Store Analysis Results Data (ARD)</span></span>
<span><span class="va">ard_content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  analysis_id <span class="op">=</span> <span class="st">"DEMO01"</span>,</span>
<span>  row_type <span class="op">=</span> <span class="st">"header"</span>,</span>
<span>  row_label <span class="op">=</span> <span class="st">"Age (years)"</span>,</span>
<span>  treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Placebo"</span>, <span class="st">"Xanomeline Low"</span>, <span class="st">"Xanomeline High"</span><span class="op">)</span>,</span>
<span>  n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">86</span>, <span class="fl">84</span>, <span class="fl">84</span><span class="op">)</span>,</span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">75.2</span>, <span class="fl">75.7</span>, <span class="fl">74.4</span><span class="op">)</span>,</span>
<span>  sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8.59</span>, <span class="fl">7.89</span>, <span class="fl">7.89</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"regulatory_documents"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>content <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">content</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>        doc_type <span class="op">=</span> <span class="st">"ARD"</span>,</span>
<span>        doc_version <span class="op">=</span> <span class="st">"1.0"</span>,</span>
<span>        content <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">ard_content</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        created_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        description <span class="op">=</span> <span class="st">"Analysis Results Data for Demographics Table"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">doc_type</span>, <span class="va">doc_version</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"regulatory_documents"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add demographics ARD"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dataset-specifications">Dataset Specifications<a class="anchor" aria-label="anchor" href="#dataset-specifications"></a>
</h3>
<p>Store dataset specifications alongside the data:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Store ADSL specifications</span></span>
<span><span class="va">adsl_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  dataset <span class="op">=</span> <span class="st">"ADSL"</span>,</span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USUBJID"</span>, <span class="st">"AGE"</span>, <span class="st">"AGEGR1"</span>, <span class="st">"TRT01P"</span>, <span class="st">"SAFFL"</span><span class="op">)</span>,</span>
<span>  label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Unique Subject Identifier"</span>,</span>
<span>    <span class="st">"Age"</span>,</span>
<span>    <span class="st">"Age Group 1"</span>,</span>
<span>    <span class="st">"Planned Treatment"</span>,</span>
<span>    <span class="st">"Safety Population Flag"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"text"</span>, <span class="st">"num"</span>, <span class="st">"text"</span>, <span class="st">"text"</span>, <span class="st">"text"</span><span class="op">)</span>,</span>
<span>  length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">8</span>, <span class="fl">10</span>, <span class="fl">40</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  derivation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DM.USUBJID"</span>, <span class="st">"DM.AGE"</span>, <span class="st">"Derived from AGE"</span>, <span class="st">"DM.ARM"</span>, <span class="st">"Derived"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/create_table.html">create_table</a></span><span class="op">(</span><span class="va">adsl_spec</span>, <span class="st">"dataset_specifications"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add ADSL specifications"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Query specifications when needed</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"dataset_specifications"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dataset</span> <span class="op">==</span> <span class="st">"ADSL"</span><span class="op">)</span></span></code></pre></div>
<p>This unified approach ensures that all submission artifacts are
version-controlled alongside the datasets they describe, maintaining
perfect alignment between data and documentation.</p>
</div>
</div>
<div class="section level2">
<h2 id="organizational-structure-and-cohesion">Organizational Structure and Cohesion<a class="anchor" aria-label="anchor" href="#organizational-structure-and-cohesion"></a>
</h2>
<p>One of the key advantages of the data lake approach is that it
preserves and leverages the inherently relational structure of CDISC
data.</p>
<div class="section level3">
<h3 id="relational-structure-beyond-flat-files">Relational Structure: Beyond Flat Files<a class="anchor" aria-label="anchor" href="#relational-structure-beyond-flat-files"></a>
</h3>
<p>Many clinical trial workflows store each SDTM domain and ADaM dataset
as separate flat files (XPT, SAS7BDAT, CSV). While this meets regulatory
requirements for submission formats, it often loses the relational
structure inherent in CDISC standards during day-to-day analysis work.
Every SDTM domain shares <code>STUDYID</code> and <code>USUBJID</code>
as keys, and domains are explicitly designed to relate to each other
(e.g., EX records link to DM subjects, AE records link to both DM and
EX).</p>
<p>While some organizations use SAS datasets in databases or other
database solutions, DuckLake provides an R-native approach that
preserves these relationships with version control built in:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Traditional approach: Load multiple files, manually join</span></span>
<span><span class="co"># adsl &lt;- read_xpt("adsl.xpt")</span></span>
<span><span class="co"># ex &lt;- read_xpt("ex.xpt")</span></span>
<span><span class="co"># ae &lt;- read_xpt("ae.xpt")</span></span>
<span><span class="co"># result &lt;- adsl |&gt; left_join(ex, ...) |&gt; left_join(ae, ...)</span></span>
<span></span>
<span><span class="co"># DuckLake approach: Query across related tables directly using dplyr</span></span>
<span><span class="co"># Complex cross-domain query without loading all data</span></span>
<span><span class="va">adsl_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span></span>
<span><span class="va">ex_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ex"</span><span class="op">)</span></span>
<span><span class="va">ae_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ae"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adsl_tbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SAFFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ex_tbl</span>, by <span class="op">=</span> <span class="st">"USUBJID"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ae_tbl</span>, by <span class="op">=</span> <span class="st">"USUBJID"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AGE</span>, <span class="va">TRT01P</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n_aes <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="va">AESEQ</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_dose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">EXDOSE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">n_aes</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">#&gt;    USUBJID       AGE TRT01P               n_aes total_dose</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 01-701-1302    61 Xanomeline High Dose    23       <span style="text-decoration: underline;">3</span>105</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 01-717-1004    80 Xanomeline Low Dose     19       <span style="text-decoration: underline;">3</span>078</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 01-718-1427    74 Xanomeline High Dose    16       <span style="text-decoration: underline;">2</span>160</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 01-704-1266    82 Xanomeline High Dose    16       <span style="text-decoration: underline;">2</span>160</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 01-709-1029    82 Xanomeline High Dose    16       <span style="text-decoration: underline;">3</span>024</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 01-701-1192    80 Xanomeline Low Dose     15       <span style="text-decoration: underline;">2</span>430</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 01-701-1275    61 Xanomeline High Dose    15       <span style="text-decoration: underline;">2</span>025</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 01-713-1179    64 Placebo                 15          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 01-709-1309    65 Xanomeline High Dose    15       <span style="text-decoration: underline;">2</span>835</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 01-711-1143    76 Xanomeline Low Dose     14       <span style="text-decoration: underline;">1</span>512</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data-warehouse-benefits">Data Warehouse Benefits<a class="anchor" aria-label="anchor" href="#data-warehouse-benefits"></a>
</h3>
<p>This approach provides traditional data warehouse capabilities for
clinical trials:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Single source of truth - all datasets in one repository</span></span>
<span><span class="co"># List all tables in the data lake</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbListTables.html" class="external-link">dbListTables</a></span><span class="op">(</span><span class="fu">duckplyr</span><span class="fu">:::</span><span class="fu">get_default_duckdb_connection</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "adae"                                 </span></span>
<span><span class="co">#&gt;  [2] "adpc"                                 </span></span>
<span><span class="co">#&gt;  [3] "adsl"                                 </span></span>
<span><span class="co">#&gt;  [4] "ae"                                   </span></span>
<span><span class="co">#&gt;  [5] "ae_raw"                               </span></span>
<span><span class="co">#&gt;  [6] "dm"                                   </span></span>
<span><span class="co">#&gt;  [7] "dm_raw"                               </span></span>
<span><span class="co">#&gt;  [8] "ds"                                   </span></span>
<span><span class="co">#&gt;  [9] "ds_raw"                               </span></span>
<span><span class="co">#&gt; [10] "ducklake_column"                      </span></span>
<span><span class="co">#&gt; [11] "ducklake_column_mapping"              </span></span>
<span><span class="co">#&gt; [12] "ducklake_column_tag"                  </span></span>
<span><span class="co">#&gt; [13] "ducklake_data_file"                   </span></span>
<span><span class="co">#&gt; [14] "ducklake_delete_file"                 </span></span>
<span><span class="co">#&gt; [15] "ducklake_file_column_stats"           </span></span>
<span><span class="co">#&gt; [16] "ducklake_file_partition_value"        </span></span>
<span><span class="co">#&gt; [17] "ducklake_files_scheduled_for_deletion"</span></span>
<span><span class="co">#&gt; [18] "ducklake_inlined_data_tables"         </span></span>
<span><span class="co">#&gt; [19] "ducklake_metadata"                    </span></span>
<span><span class="co">#&gt; [20] "ducklake_name_mapping"                </span></span>
<span><span class="co">#&gt; [21] "ducklake_partition_column"            </span></span>
<span><span class="co">#&gt; [22] "ducklake_partition_info"              </span></span>
<span><span class="co">#&gt; [23] "ducklake_schema"                      </span></span>
<span><span class="co">#&gt; [24] "ducklake_schema_versions"             </span></span>
<span><span class="co">#&gt; [25] "ducklake_snapshot"                    </span></span>
<span><span class="co">#&gt; [26] "ducklake_snapshot_changes"            </span></span>
<span><span class="co">#&gt; [27] "ducklake_table"                       </span></span>
<span><span class="co">#&gt; [28] "ducklake_table_column_stats"          </span></span>
<span><span class="co">#&gt; [29] "ducklake_table_stats"                 </span></span>
<span><span class="co">#&gt; [30] "ducklake_tag"                         </span></span>
<span><span class="co">#&gt; [31] "ducklake_view"                        </span></span>
<span><span class="co">#&gt; [32] "ex"                                   </span></span>
<span><span class="co">#&gt; [33] "ex_raw"                               </span></span>
<span><span class="co">#&gt; [34] "pc"                                   </span></span>
<span><span class="co">#&gt; [35] "pc_raw"                               </span></span>
<span><span class="co">#&gt; [36] "regulatory_documents"                 </span></span>
<span><span class="co">#&gt; [37] "suppdm"                               </span></span>
<span><span class="co">#&gt; [38] "suppdm_raw"                           </span></span>
<span><span class="co">#&gt; [39] "vs"                                   </span></span>
<span><span class="co">#&gt; [40] "vs_raw"</span></span>
<span></span>
<span><span class="co"># 2. Efficient filtering before loading into R</span></span>
<span><span class="co"># Only load subjects with adverse events</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">AESEV</span> <span class="op">==</span> <span class="st">"SEVERE"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 1]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;    USUBJID    </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 01-704-1008</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 01-704-1445</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 01-710-1070</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 01-710-1368</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 01-714-1195</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 01-716-1189</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 01-718-1427</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 01-703-1086</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 01-703-1119</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 01-706-1049</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span>
<span></span>
<span><span class="co"># 3. Aggregations performed at database level</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">TRTEMFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">TRT01A</span>, <span class="va">AESEV</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n_events <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    n_subjects <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="va">USUBJID</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 4]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;   TRT01A               AESEV    n_events n_subjects</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Placebo              MODERATE       65         25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Xanomeline Low Dose  SEVERE         25         16</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Placebo              MILD          210         58</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Xanomeline High Dose SEVERE         10          8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Xanomeline High Dose MILD          287         65</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Xanomeline Low Dose  MODERATE      170         58</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> Placebo              SEVERE          6          5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> Xanomeline Low Dose  MILD          232         64</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> Xanomeline High Dose MODERATE      115         46</span></span>
<span></span>
<span><span class="co"># 4. Joins across SDTM and ADaM layers</span></span>
<span><span class="co"># Example: Find date discrepancies between SDTM and ADaM</span></span>
<span><span class="va">ae_sdtm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"ae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AESEQ</span>, ae_date <span class="op">=</span> <span class="va">AESTDTC</span>, ae_term <span class="op">=</span> <span class="va">AEDECOD</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adae_adam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AESEQ</span>, adae_date <span class="op">=</span> <span class="va">ASTDT</span>, adae_term <span class="op">=</span> <span class="va">AEDECOD</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ae_sdtm</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">adae_adam</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USUBJID"</span>, <span class="st">"AESEQ"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Convert SDTM character date to comparable format for filtering</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ae_date_comparable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">ae_date</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ae_date_comparable</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">adae_date</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">USUBJID</span>,</span>
<span>    sdtm_start_date <span class="op">=</span> <span class="va">ae_date</span>,</span>
<span>    adam_start_date <span class="op">=</span> <span class="va">adae_date</span>,</span>
<span>    sdtm_term <span class="op">=</span> <span class="va">ae_term</span>,</span>
<span>    adam_term <span class="op">=</span> <span class="va">adae_term</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 5]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5 variables: USUBJID &lt;chr&gt;, sdtm_start_date &lt;chr&gt;, adam_start_date &lt;date&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   sdtm_term &lt;chr&gt;, adam_term &lt;chr&gt;</span></span></span>
<span><span class="co"># Note: This returns 0 rows with clean pharmaversesdtm data,</span></span>
<span><span class="co"># but demonstrates how to check for data quality issues across layers</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cohesive-dataset-relationships">Cohesive Dataset Relationships<a class="anchor" aria-label="anchor" href="#cohesive-dataset-relationships"></a>
</h3>
<p>Let’s explore how our datasets are connected:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List all tables in the data lake</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbListTables.html" class="external-link">dbListTables</a></span><span class="op">(</span><span class="fu">duckplyr</span><span class="fu">:::</span><span class="fu">get_default_duckdb_connection</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "adae"                                 </span></span>
<span><span class="co">#&gt;  [2] "adpc"                                 </span></span>
<span><span class="co">#&gt;  [3] "adsl"                                 </span></span>
<span><span class="co">#&gt;  [4] "ae"                                   </span></span>
<span><span class="co">#&gt;  [5] "ae_raw"                               </span></span>
<span><span class="co">#&gt;  [6] "dm"                                   </span></span>
<span><span class="co">#&gt;  [7] "dm_raw"                               </span></span>
<span><span class="co">#&gt;  [8] "ds"                                   </span></span>
<span><span class="co">#&gt;  [9] "ds_raw"                               </span></span>
<span><span class="co">#&gt; [10] "ducklake_column"                      </span></span>
<span><span class="co">#&gt; [11] "ducklake_column_mapping"              </span></span>
<span><span class="co">#&gt; [12] "ducklake_column_tag"                  </span></span>
<span><span class="co">#&gt; [13] "ducklake_data_file"                   </span></span>
<span><span class="co">#&gt; [14] "ducklake_delete_file"                 </span></span>
<span><span class="co">#&gt; [15] "ducklake_file_column_stats"           </span></span>
<span><span class="co">#&gt; [16] "ducklake_file_partition_value"        </span></span>
<span><span class="co">#&gt; [17] "ducklake_files_scheduled_for_deletion"</span></span>
<span><span class="co">#&gt; [18] "ducklake_inlined_data_tables"         </span></span>
<span><span class="co">#&gt; [19] "ducklake_metadata"                    </span></span>
<span><span class="co">#&gt; [20] "ducklake_name_mapping"                </span></span>
<span><span class="co">#&gt; [21] "ducklake_partition_column"            </span></span>
<span><span class="co">#&gt; [22] "ducklake_partition_info"              </span></span>
<span><span class="co">#&gt; [23] "ducklake_schema"                      </span></span>
<span><span class="co">#&gt; [24] "ducklake_schema_versions"             </span></span>
<span><span class="co">#&gt; [25] "ducklake_snapshot"                    </span></span>
<span><span class="co">#&gt; [26] "ducklake_snapshot_changes"            </span></span>
<span><span class="co">#&gt; [27] "ducklake_table"                       </span></span>
<span><span class="co">#&gt; [28] "ducklake_table_column_stats"          </span></span>
<span><span class="co">#&gt; [29] "ducklake_table_stats"                 </span></span>
<span><span class="co">#&gt; [30] "ducklake_tag"                         </span></span>
<span><span class="co">#&gt; [31] "ducklake_view"                        </span></span>
<span><span class="co">#&gt; [32] "ex"                                   </span></span>
<span><span class="co">#&gt; [33] "ex_raw"                               </span></span>
<span><span class="co">#&gt; [34] "pc"                                   </span></span>
<span><span class="co">#&gt; [35] "pc_raw"                               </span></span>
<span><span class="co">#&gt; [36] "regulatory_documents"                 </span></span>
<span><span class="co">#&gt; [37] "suppdm"                               </span></span>
<span><span class="co">#&gt; [38] "suppdm_raw"                           </span></span>
<span><span class="co">#&gt; [39] "vs"                                   </span></span>
<span><span class="co">#&gt; [40] "vs_raw"</span></span>
<span></span>
<span><span class="co"># View snapshot history for key tables</span></span>
<span><span class="va">metadata_tables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dm"</span>, <span class="st">"ex"</span>, <span class="st">"ae"</span>, <span class="st">"pc"</span>, </span>
<span>                     <span class="st">"adsl"</span>, <span class="st">"adae"</span>, <span class="st">"adpc"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Collect snapshots for all tables</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">metadata_tables</span>, <span class="op">~</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/list_table_snapshots.html">list_table_snapshots</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>table <span class="op">=</span> <span class="va">.x</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">table</span>, <span class="va">snapshot_id</span>, <span class="va">snapshot_time</span>, <span class="va">changes</span><span class="op">)</span></span>
<span><span class="co">#&gt;   table snapshot_id       snapshot_time</span></span>
<span><span class="co">#&gt; 1    dm           2 2026-02-09 21:16:40</span></span>
<span><span class="co">#&gt; 2    ex           8 2026-02-09 21:16:41</span></span>
<span><span class="co">#&gt; 3    ae          10 2026-02-09 21:16:41</span></span>
<span><span class="co">#&gt; 4    pc          14 2026-02-09 21:16:41</span></span>
<span><span class="co">#&gt; 5  adsl          15 2026-02-09 21:16:42</span></span>
<span><span class="co">#&gt; 6  adae          16 2026-02-09 21:16:43</span></span>
<span><span class="co">#&gt; 7  adpc          17 2026-02-09 21:16:44</span></span>
<span><span class="co">#&gt;                                               changes</span></span>
<span><span class="co">#&gt; 1    tables_created, tables_inserted_into, main.dm, 2</span></span>
<span><span class="co">#&gt; 2    tables_created, tables_inserted_into, main.ex, 8</span></span>
<span><span class="co">#&gt; 3   tables_created, tables_inserted_into, main.ae, 10</span></span>
<span><span class="co">#&gt; 4   tables_created, tables_inserted_into, main.pc, 14</span></span>
<span><span class="co">#&gt; 5 tables_created, tables_inserted_into, main.adsl, 15</span></span>
<span><span class="co">#&gt; 6 tables_created, tables_inserted_into, main.adae, 16</span></span>
<span><span class="co">#&gt; 7 tables_created, tables_inserted_into, main.adpc, 17</span></span>
<span></span>
<span><span class="co"># Check all ADAE subjects exist in ADSL</span></span>
<span><span class="va">adae_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span></span>
<span><span class="va">adsl_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">integrity_check</span> <span class="op">&lt;-</span> <span class="va">adae_tbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join</a></span><span class="op">(</span><span class="va">adsl_tbl</span>, by <span class="op">=</span> <span class="st">"USUBJID"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>orphaned_records <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ADAE records without ADSL subject:</span></span>
<span><span class="va">integrity_check</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">orphaned_records</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>This relational approach means your clinical trial data lake
functions as a purpose-built data warehouse, designed specifically for
the relational nature of CDISC standards.</p>
</div>
</div>
<div class="section level2">
<h2 id="demonstrating-core-functionality">Demonstrating Core Functionality<a class="anchor" aria-label="anchor" href="#demonstrating-core-functionality"></a>
</h2>
<div class="section level3">
<h3 id="version-control-and-snapshots">Version Control and Snapshots<a class="anchor" aria-label="anchor" href="#version-control-and-snapshots"></a>
</h3>
<p>Every modification to tables is automatically versioned. Let’s
demonstrate by adding new derived variables to ADSL:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add new derived columns using dplyr syntax</span></span>
<span><span class="co"># replace_table() handles the DROP/CREATE cycle internally</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      AGE65FL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">65</span>, <span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span>,</span>
<span>      AGECAT <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">65</span> <span class="op">~</span> <span class="st">"&lt;65"</span>,</span>
<span>        <span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">65</span> <span class="op">&amp;</span> <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">75</span> <span class="op">~</span> <span class="st">"65-74"</span>,</span>
<span>        <span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">75</span> <span class="op">~</span> <span class="st">"&gt;=75"</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add age categorization vars"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># View version history - should now show 2 snapshots</span></span>
<span><span class="fu"><a href="../reference/list_table_snapshots.html">list_table_snapshots</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span></span>
<span><span class="co">#&gt;    snapshot_id       snapshot_time schema_version</span></span>
<span><span class="co">#&gt; 16          15 2026-02-09 21:16:42             15</span></span>
<span><span class="co">#&gt; 22          21 2026-02-09 21:16:45             21</span></span>
<span><span class="co">#&gt;                                                                    changes</span></span>
<span><span class="co">#&gt; 16                     tables_created, tables_inserted_into, main.adsl, 15</span></span>
<span><span class="co">#&gt; 22 tables_created, tables_dropped, tables_inserted_into, main.adsl, 15, 21</span></span>
<span><span class="co">#&gt;     author              commit_message</span></span>
<span><span class="co">#&gt; 16 T Gerke         Create ADSL dataset</span></span>
<span><span class="co">#&gt; 22 T Gerke Add age categorization vars</span></span>
<span><span class="co">#&gt;                                                                      commit_extra_info</span></span>
<span><span class="co">#&gt; 16 Derived from DM, SUPPDM, DS, EX; includes treatment dates, safety flags, age groups</span></span>
<span><span class="co">#&gt; 22                                                                                &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Verify new columns exist</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AGE</span>, <span class="va">AGE65FL</span>, <span class="va">AGECAT</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 4]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;   USUBJID       AGE AGE65FL AGECAT</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 01-701-1015    63 N       &lt;65   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 01-701-1023    64 N       &lt;65   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 01-701-1028    71 Y       65-74 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 01-701-1033    74 Y       65-74 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 01-701-1034    77 Y       &gt;=75</span></span></code></pre></div>
<div class="section level4">
<h4 id="best-practice-use-replace_table-for-all-modifications">Best Practice: Use replace_table() for All Modifications<a class="anchor" aria-label="anchor" href="#best-practice-use-replace_table-for-all-modifications"></a>
</h4>
<p>For clinical trial data workflows, <strong>always use
<code><a href="../reference/replace_table.html">replace_table()</a></code> wrapped in
<code><a href="../reference/with_transaction.html">with_transaction()</a></code></strong> to ensure complete audit trails
and regulatory compliance.</p>
<p><strong>Why replace_table() is essential for GxP work:</strong></p>
<ul>
<li>✅ <strong>Creates versioned snapshots</strong> - Every change is
recorded and can be time-traveled back to</li>
<li>✅ <strong>Complete audit trails</strong> - Records what changed,
when, and by whom</li>
<li>✅ <strong>Regulatory compliance</strong> - Meets 21 CFR Part 11 and
ICH GCP requirements</li>
<li>✅ <strong>Data lineage</strong> - Proves data integrity for
regulatory inspections</li>
<li>✅ <strong>Schema flexibility</strong> - Add/remove columns or
modify values with the same approach</li>
<li>✅ <strong>Natural dplyr interface</strong> -
<code>get_ducklake_table(name) |&gt; mutate(...) |&gt; replace_table(name)</code>
</li>
</ul>
<p><strong>For all modifications in clinical trials</strong>, use this
pattern:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Correcting a specific value - creates auditable snapshot</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>SAFFL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">USUBJID</span> <span class="op">==</span> <span class="st">"01-701-1015"</span>, <span class="st">"N"</span>, <span class="va">SAFFL</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Correct safety flag"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Adding new derived columns - creates auditable snapshot</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AGE65FL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">65</span>, <span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Add age 65+ flag"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Both operations create snapshots you can time-travel back to and
include in your regulatory audit trail.</p>
</div>
<div class="section level4">
<h4 id="iterative-development-with-full-audit-trail">Iterative Development with Full Audit Trail<a class="anchor" aria-label="anchor" href="#iterative-development-with-full-audit-trail"></a>
</h4>
<p>When developing derivations, create a snapshot at each meaningful
iteration to maintain a complete audit trail:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Iteration 1: First attempt (creates snapshot v2)</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AGECAT_TEST <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">50</span> <span class="op">~</span> <span class="st">"Young"</span>,</span>
<span>      <span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">50</span> <span class="op">~</span> <span class="st">"Older"</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Test age categories v1"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Iteration 2: Refinement (creates snapshot v3)</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AGECAT_TEST <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">40</span> <span class="op">~</span> <span class="st">"18-39"</span>,</span>
<span>      <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">65</span> <span class="op">~</span> <span class="st">"40-64"</span>,</span>
<span>      <span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">65</span> <span class="op">~</span> <span class="st">"65+"</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Refine age categories v2"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Iteration 3: Final version (creates snapshot v4)</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      AGECAT_TEST <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      AGECAT2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">40</span> <span class="op">~</span> <span class="st">"18-39"</span>,</span>
<span>        <span class="va">AGE</span> <span class="op">&lt;</span> <span class="fl">65</span> <span class="op">~</span> <span class="st">"40-64"</span>,</span>
<span>        <span class="va">AGE</span> <span class="op">&gt;=</span> <span class="fl">65</span> <span class="op">~</span> <span class="st">"65+"</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Missing"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span>,</span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Finalize age categories"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Complete audit trail available</span></span>
<span><span class="va">snapshots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/list_table_snapshots.html">list_table_snapshots</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span></span>
<span><span class="va">snapshots</span>  <span class="co"># Shows all iterations with snapshot metadata</span></span>
<span><span class="co">#&gt;    snapshot_id       snapshot_time schema_version</span></span>
<span><span class="co">#&gt; 16          15 2026-02-09 21:16:42             15</span></span>
<span><span class="co">#&gt; 22          21 2026-02-09 21:16:45             21</span></span>
<span><span class="co">#&gt; 23          22 2026-02-09 21:16:45             22</span></span>
<span><span class="co">#&gt; 24          23 2026-02-09 21:16:45             23</span></span>
<span><span class="co">#&gt; 25          24 2026-02-09 21:16:46             24</span></span>
<span><span class="co">#&gt;                                                                    changes</span></span>
<span><span class="co">#&gt; 16                     tables_created, tables_inserted_into, main.adsl, 15</span></span>
<span><span class="co">#&gt; 22 tables_created, tables_dropped, tables_inserted_into, main.adsl, 15, 21</span></span>
<span><span class="co">#&gt; 23 tables_created, tables_dropped, tables_inserted_into, main.adsl, 21, 22</span></span>
<span><span class="co">#&gt; 24 tables_created, tables_dropped, tables_inserted_into, main.adsl, 22, 23</span></span>
<span><span class="co">#&gt; 25 tables_created, tables_dropped, tables_inserted_into, main.adsl, 23, 24</span></span>
<span><span class="co">#&gt;     author              commit_message</span></span>
<span><span class="co">#&gt; 16 T Gerke         Create ADSL dataset</span></span>
<span><span class="co">#&gt; 22 T Gerke Add age categorization vars</span></span>
<span><span class="co">#&gt; 23 T Gerke      Test age categories v1</span></span>
<span><span class="co">#&gt; 24 T Gerke    Refine age categories v2</span></span>
<span><span class="co">#&gt; 25 T Gerke     Finalize age categories</span></span>
<span><span class="co">#&gt;                                                                      commit_extra_info</span></span>
<span><span class="co">#&gt; 16 Derived from DM, SUPPDM, DS, EX; includes treatment dates, safety flags, age groups</span></span>
<span><span class="co">#&gt; 22                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 23                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 24                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 25                                                                                &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Each row represents a point in time you can restore to</span></span>
<span><span class="co"># - snapshot_id: Unique identifier for this version</span></span>
<span><span class="co"># - snapshot_time: When this version was created</span></span>
<span><span class="co"># - changes: What operations created this snapshot</span></span>
<span></span>
<span><span class="co"># Time-travel to specific snapshots using snapshot_id</span></span>
<span><span class="co"># Use actual snapshot IDs from the list (first, second, and last)</span></span>
<span><span class="va">snapshot_ids</span> <span class="op">&lt;-</span> <span class="va">snapshots</span><span class="op">$</span><span class="va">snapshot_id</span></span>
<span><span class="va">adsl_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table_version.html">get_ducklake_table_version</a></span><span class="op">(</span><span class="st">"adsl"</span>, <span class="va">snapshot_ids</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">adsl_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table_version.html">get_ducklake_table_version</a></span><span class="op">(</span><span class="st">"adsl"</span>, <span class="va">snapshot_ids</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">adsl_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table_version.html">get_ducklake_table_version</a></span><span class="op">(</span><span class="st">"adsl"</span>, <span class="va">snapshot_ids</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">snapshot_ids</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or use snapshot times for time-travel</span></span>
<span><span class="co"># Note: Add 1 second to ensure we query AFTER the snapshot was created</span></span>
<span><span class="va">adsl_asof</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table_asof.html">get_ducklake_table_asof</a></span><span class="op">(</span><span class="st">"adsl"</span>, <span class="va">snapshots</span><span class="op">$</span><span class="va">snapshot_time</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare columns across iterations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">adsl_v1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Initial version</span></span>
<span><span class="co">#&gt;  [1] "STUDYID"  "DOMAIN"   "USUBJID"  "SUBJID"   "RFSTDTC"  "RFENDTC" </span></span>
<span><span class="co">#&gt;  [7] "RFXSTDTC" "RFXENDTC" "RFICDTC"  "RFPENDTC" "DTHDTC"   "DTHFL"   </span></span>
<span><span class="co">#&gt; [13] "SITEID"   "BRTHDTC"  "AGE"      "AGEU"     "SEX"      "RACE"    </span></span>
<span><span class="co">#&gt; [19] "ETHNIC"   "ARMCD"    "ARM"      "ACTARMCD" "ACTARM"   "COUNTRY" </span></span>
<span><span class="co">#&gt; [25] "DMDTC"    "DMDY"     "TRTSDTM"  "TRTEDTM"  "TRTSDT"   "TRTEDT"  </span></span>
<span><span class="co">#&gt; [31] "TRTDURD"  "SAFFL"    "TRT01P"   "TRT01A"   "AGEGR1"   "AGEGR1N" </span></span>
<span><span class="co">#&gt; [37] "RANDDT"   "EOSDT"    "EOSSTT"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">adsl_final</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Final version with all derivations</span></span>
<span><span class="co">#&gt;  [1] "STUDYID"  "DOMAIN"   "USUBJID"  "SUBJID"   "RFSTDTC"  "RFENDTC" </span></span>
<span><span class="co">#&gt;  [7] "RFXSTDTC" "RFXENDTC" "RFICDTC"  "RFPENDTC" "DTHDTC"   "DTHFL"   </span></span>
<span><span class="co">#&gt; [13] "SITEID"   "BRTHDTC"  "AGE"      "AGEU"     "SEX"      "RACE"    </span></span>
<span><span class="co">#&gt; [19] "ETHNIC"   "ARMCD"    "ARM"      "ACTARMCD" "ACTARM"   "COUNTRY" </span></span>
<span><span class="co">#&gt; [25] "DMDTC"    "DMDY"     "TRTSDTM"  "TRTEDTM"  "TRTSDT"   "TRTEDT"  </span></span>
<span><span class="co">#&gt; [31] "TRTDURD"  "SAFFL"    "TRT01P"   "TRT01A"   "AGEGR1"   "AGEGR1N" </span></span>
<span><span class="co">#&gt; [37] "RANDDT"   "EOSDT"    "EOSSTT"   "AGE65FL"  "AGECAT"   "AGECAT2"</span></span></code></pre></div>
<p>This GxP-compliant approach ensures:</p>
<ul>
<li>Complete audit trail of all derivation iterations</li>
<li>Ability to recreate any intermediate state</li>
<li>Proof of what changed and when for regulatory inspections</li>
<li>Data lineage from initial to final derivation</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="time-travel">Time Travel<a class="anchor" aria-label="anchor" href="#time-travel"></a>
</h3>
<p>Query data as it existed at a specific point in time:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the current version</span></span>
<span><span class="va">adsl_current</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the version history for adsl</span></span>
<span><span class="va">versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/list_table_snapshots.html">list_table_snapshots</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">versions</span><span class="op">)</span></span>
<span><span class="co">#&gt;    snapshot_id       snapshot_time schema_version</span></span>
<span><span class="co">#&gt; 16          15 2026-02-09 21:16:42             15</span></span>
<span><span class="co">#&gt; 22          21 2026-02-09 21:16:45             21</span></span>
<span><span class="co">#&gt; 23          22 2026-02-09 21:16:45             22</span></span>
<span><span class="co">#&gt; 24          23 2026-02-09 21:16:45             23</span></span>
<span><span class="co">#&gt; 25          24 2026-02-09 21:16:46             24</span></span>
<span><span class="co">#&gt;                                                                    changes</span></span>
<span><span class="co">#&gt; 16                     tables_created, tables_inserted_into, main.adsl, 15</span></span>
<span><span class="co">#&gt; 22 tables_created, tables_dropped, tables_inserted_into, main.adsl, 15, 21</span></span>
<span><span class="co">#&gt; 23 tables_created, tables_dropped, tables_inserted_into, main.adsl, 21, 22</span></span>
<span><span class="co">#&gt; 24 tables_created, tables_dropped, tables_inserted_into, main.adsl, 22, 23</span></span>
<span><span class="co">#&gt; 25 tables_created, tables_dropped, tables_inserted_into, main.adsl, 23, 24</span></span>
<span><span class="co">#&gt;     author              commit_message</span></span>
<span><span class="co">#&gt; 16 T Gerke         Create ADSL dataset</span></span>
<span><span class="co">#&gt; 22 T Gerke Add age categorization vars</span></span>
<span><span class="co">#&gt; 23 T Gerke      Test age categories v1</span></span>
<span><span class="co">#&gt; 24 T Gerke    Refine age categories v2</span></span>
<span><span class="co">#&gt; 25 T Gerke     Finalize age categories</span></span>
<span><span class="co">#&gt;                                                                      commit_extra_info</span></span>
<span><span class="co">#&gt; 16 Derived from DM, SUPPDM, DS, EX; includes treatment dates, safety flags, age groups</span></span>
<span><span class="co">#&gt; 22                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 23                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 24                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 25                                                                                &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Get data from the first snapshot version</span></span>
<span><span class="va">first_snapshot_id</span> <span class="op">&lt;-</span> <span class="va">versions</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">snapshot_id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">adsl_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table_version.html">get_ducklake_table_version</a></span><span class="op">(</span></span>
<span>  table_name <span class="op">=</span> <span class="st">"adsl"</span>,</span>
<span>  version <span class="op">=</span> <span class="va">first_snapshot_id</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare versions - earlier version shouldn't have derived variables added later</span></span>
<span><span class="va">adsl_v1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 306 × 39</span></span></span>
<span><span class="co">#&gt;    STUDYID      DOMAIN USUBJID  SUBJID RFSTDTC RFENDTC RFXSTDTC RFXENDTC RFICDTC</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> CDISCPILOT01 DM     01-701-… 1015   2014-0… 2014-0… 2014-01… 2014-07… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> CDISCPILOT01 DM     01-701-… 1023   2012-0… 2012-0… 2012-08… 2012-09… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> CDISCPILOT01 DM     01-701-… 1028   2013-0… 2014-0… 2013-07… 2014-01… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> CDISCPILOT01 DM     01-701-… 1033   2014-0… 2014-0… 2014-03… 2014-03… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> CDISCPILOT01 DM     01-701-… 1034   2014-0… 2014-1… 2014-07… 2014-12… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> CDISCPILOT01 DM     01-701-… 1047   2013-0… 2013-0… 2013-02… 2013-03… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> CDISCPILOT01 DM     01-701-… 1057   <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> CDISCPILOT01 DM     01-701-… 1097   2014-0… 2014-0… 2014-01… 2014-07… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> CDISCPILOT01 DM     01-701-… 1111   2012-0… 2012-0… 2012-09… 2012-09… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> CDISCPILOT01 DM     01-701-… 1115   2012-1… 2013-0… 2012-11… 2013-01… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 296 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 30 more variables: RFPENDTC &lt;chr&gt;, DTHDTC &lt;chr&gt;, DTHFL &lt;chr&gt;, SITEID &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   BRTHDTC &lt;chr&gt;, AGE &lt;dbl&gt;, AGEU &lt;chr&gt;, SEX &lt;chr&gt;, RACE &lt;chr&gt;, ETHNIC &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ARMCD &lt;chr&gt;, ARM &lt;chr&gt;, ACTARMCD &lt;chr&gt;, ACTARM &lt;chr&gt;, COUNTRY &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   DMDTC &lt;chr&gt;, DMDY &lt;dbl&gt;, TRTSDTM &lt;dttm&gt;, TRTEDTM &lt;dttm&gt;, TRTSDT &lt;date&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   TRTEDT &lt;date&gt;, TRTDURD &lt;dbl&gt;, SAFFL &lt;chr&gt;, TRT01P &lt;chr&gt;, TRT01A &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   AGEGR1 &lt;chr&gt;, AGEGR1N &lt;dbl&gt;, RANDDT &lt;date&gt;, EOSDT &lt;date&gt;, EOSSTT &lt;chr&gt;</span></span></span>
<span><span class="va">adsl_current</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 306 × 42</span></span></span>
<span><span class="co">#&gt;    STUDYID      DOMAIN USUBJID  SUBJID RFSTDTC RFENDTC RFXSTDTC RFXENDTC RFICDTC</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> CDISCPILOT01 DM     01-701-… 1015   2014-0… 2014-0… 2014-01… 2014-07… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> CDISCPILOT01 DM     01-701-… 1023   2012-0… 2012-0… 2012-08… 2012-09… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> CDISCPILOT01 DM     01-701-… 1028   2013-0… 2014-0… 2013-07… 2014-01… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> CDISCPILOT01 DM     01-701-… 1033   2014-0… 2014-0… 2014-03… 2014-03… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> CDISCPILOT01 DM     01-701-… 1034   2014-0… 2014-1… 2014-07… 2014-12… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> CDISCPILOT01 DM     01-701-… 1047   2013-0… 2013-0… 2013-02… 2013-03… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> CDISCPILOT01 DM     01-701-… 1057   <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> CDISCPILOT01 DM     01-701-… 1097   2014-0… 2014-0… 2014-01… 2014-07… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> CDISCPILOT01 DM     01-701-… 1111   2012-0… 2012-0… 2012-09… 2012-09… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> CDISCPILOT01 DM     01-701-… 1115   2012-1… 2013-0… 2012-11… 2013-01… <span style="color: #BB0000;">NA</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 296 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 33 more variables: RFPENDTC &lt;chr&gt;, DTHDTC &lt;chr&gt;, DTHFL &lt;chr&gt;, SITEID &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   BRTHDTC &lt;chr&gt;, AGE &lt;dbl&gt;, AGEU &lt;chr&gt;, SEX &lt;chr&gt;, RACE &lt;chr&gt;, ETHNIC &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ARMCD &lt;chr&gt;, ARM &lt;chr&gt;, ACTARMCD &lt;chr&gt;, ACTARM &lt;chr&gt;, COUNTRY &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   DMDTC &lt;chr&gt;, DMDY &lt;dbl&gt;, TRTSDTM &lt;dttm&gt;, TRTEDTM &lt;dttm&gt;, TRTSDT &lt;date&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   TRTEDT &lt;date&gt;, TRTDURD &lt;dbl&gt;, SAFFL &lt;chr&gt;, TRT01P &lt;chr&gt;, TRT01A &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   AGEGR1 &lt;chr&gt;, AGEGR1N &lt;dbl&gt;, RANDDT &lt;date&gt;, EOSDT &lt;date&gt;, EOSSTT &lt;chr&gt;, …</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="transactions-for-atomic-updates">Transactions for Atomic Updates<a class="anchor" aria-label="anchor" href="#transactions-for-atomic-updates"></a>
</h3>
<p>Transactions ensure that related table updates either all succeed or
all fail together, maintaining data consistency. This is critical when
adding derived variables that must stay synchronized across
datasets.</p>
<p>Here’s an example of adding a new analysis flag to both ADSL and ADAE
atomically:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add ANALYSISFL to both ADSL and ADAE in a single atomic operation</span></span>
<span><span class="co"># with_transaction() automatically handles rollback on error</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># First, add the flag to ADSL</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ANALYSISFL <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">SAFFL</span> <span class="op">==</span> <span class="st">"Y"</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">TRTSDT</span><span class="op">)</span>, <span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span>  <span class="co"># Creates versioned snapshot</span></span>
<span>  </span>
<span>  <span class="co"># Then propagate to ADAE by joining</span></span>
<span>  <span class="va">adsl_flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">ANALYSISFL</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="st">"ANALYSISFL"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="co"># Remove if exists</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">adsl_flags</span>, by <span class="op">=</span> <span class="st">"USUBJID"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span>  <span class="co"># Creates versioned snapshot</span></span>
<span>  </span>
<span>  <span class="co"># Both updates succeed together</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Both tables updated successfully\n"</span><span class="op">)</span></span>
<span><span class="op">}</span>, author <span class="op">=</span> <span class="st">"T Gerke"</span>, commit_message <span class="op">=</span> <span class="st">"Add analysis flag"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Both tables updated successfully</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span></code></pre></div>
<p>This ensures ADSL and ADAE stay synchronized - either both get the
new <code>ANALYSISFL</code> column or neither does. The
<code><a href="../reference/with_transaction.html">with_transaction()</a></code> function automatically handles rollback
if any operation fails, making it safer than manually managing
transactions. Both updates are also versioned for audit trails.</p>
</div>
<div class="section level3">
<h3 id="updating-records">Updating Records<a class="anchor" aria-label="anchor" href="#updating-records"></a>
</h3>
<p>Update existing records while maintaining version control and audit
trails:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Update a specific record with versioning</span></span>
<span><span class="fu"><a href="../reference/with_transaction.html">with_transaction</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      AESEV <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>        <span class="va">USUBJID</span> <span class="op">==</span> <span class="st">"01-701-1015"</span> <span class="op">&amp;</span> <span class="va">AESEQ</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>        <span class="st">"SEVERE"</span>,</span>
<span>        <span class="va">AESEV</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/replace_table.html">replace_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span>,  <span class="co"># Creates versioned snapshot</span></span>
<span>  author <span class="op">=</span> <span class="st">"T Gerke"</span>,</span>
<span>  commit_message <span class="op">=</span> <span class="st">"Correct AE severity"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Transaction started</span></span>
<span><span class="co">#&gt; Transaction committed</span></span>
<span><span class="co">#&gt; Snapshot metadata updated</span></span>
<span></span>
<span><span class="co"># Verify the update</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">USUBJID</span> <span class="op">==</span> <span class="st">"01-701-1015"</span>, <span class="va">AESEQ</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AEDECOD</span>, <span class="va">AESEV</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 3]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt;   USUBJID     AEDECOD                   AESEV </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 01-701-1015 APPLICATION SITE ERYTHEMA SEVERE</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="querying-and-analysis">Querying and Analysis<a class="anchor" aria-label="anchor" href="#querying-and-analysis"></a>
</h2>
<p>The data lake enables efficient querying across all datasets:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example 1: Subject disposition summary</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">EOSSTT</span>, <span class="va">TRT01P</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">TRT01P</span>, <span class="va">EOSSTT</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:     SQL [?? x 3]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database:   DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Ordered by: TRT01P, EOSSTT</span></span></span>
<span><span class="co">#&gt;   EOSSTT    TRT01P                   n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> COMPLETED Placebo                 86</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ONGOING   Screen Failure          52</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> COMPLETED Xanomeline High Dose    84</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> COMPLETED Xanomeline Low Dose     84</span></span>
<span></span>
<span><span class="co"># Example 2: Treatment-emergent AE summary by severity</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">TRTEMFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">TRT01A</span>, <span class="va">AESEV</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">TRT01A</span>, <span class="va">AESEV</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:     SQL [?? x 3]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database:   DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Ordered by: TRT01A, AESEV</span></span></span>
<span><span class="co">#&gt;   TRT01A               AESEV        n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Placebo              MILD       209</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Placebo              MODERATE    65</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Placebo              SEVERE       7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Xanomeline High Dose MILD       287</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Xanomeline High Dose MODERATE   115</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Xanomeline High Dose SEVERE      10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> Xanomeline Low Dose  MILD       232</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> Xanomeline Low Dose  MODERATE   170</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> Xanomeline Low Dose  SEVERE      25</span></span>
<span></span>
<span><span class="co"># Example 3: PK concentration profile</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adpc"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"XAN"</span>, <span class="va">EVID</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">NFRLT</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_conc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    sd_conc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">AVAL</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">NFRLT</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:     SQL [?? x 4]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database:   DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Ordered by: NFRLT</span></span></span>
<span><span class="co">#&gt;    NFRLT     n mean_conc  sd_conc</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  0      254   0        0      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  0.08   254   0.068<span style="text-decoration: underline;">2</span>   0.045<span style="text-decoration: underline;">5</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  0.5    254   0.362    0.257  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  1      254   0.616    0.439  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  1.5    254   0.795    0.568  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  2      254   0.922    0.658  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  3      254  17.7     12.7    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  4      254   1.15     0.821  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  6      254   1.21     0.862  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  8      254   1.22     0.872  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>  9      254  14.9     10.8    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> 12      254   0.366    0.260  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> 16      254   0.110    0.076<span style="text-decoration: underline;">7</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> 18      254   9.39     6.92   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> 24      254   0.011<span style="text-decoration: underline;">4</span>   0.005<span style="text-decoration: underline;">20</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> 36      254   0.005<span style="text-decoration: underline;">00</span>  0      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span> 37      254   0.165    0.426  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span> 48      254   0.005<span style="text-decoration: underline;">00</span>  0</span></span>
<span></span>
<span><span class="co"># Example 4: Cross-domain analysis: AEs by age group</span></span>
<span><span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adae"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">TRTEMFL</span> <span class="op">==</span> <span class="st">"Y"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/get_ducklake_table.html">get_ducklake_table</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">USUBJID</span>, <span class="va">AGEGR1</span>, <span class="va">TRT01A</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"USUBJID"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">AGEGR1</span>, <span class="va">TRT01A.x</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">AGEGR1</span>, <span class="va">TRT01A.x</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:     SQL [?? x 3]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database:   DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpXQSKxf/duckplyr/duckplyr1f177927e1db.duckdb]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Ordered by: AGEGR1, TRT01A.x</span></span></span>
<span><span class="co">#&gt;   AGEGR1 TRT01A.x                 n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 18-64  Placebo                 57</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 18-64  Xanomeline High Dose    86</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 18-64  Xanomeline Low Dose     20</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> &gt;64    Placebo                224</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> &gt;64    Xanomeline High Dose   326</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> &gt;64    Xanomeline Low Dose    407</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="audit-trail-and-compliance">Audit Trail and Compliance<a class="anchor" aria-label="anchor" href="#audit-trail-and-compliance"></a>
</h2>
<p>For regulatory submissions, the complete audit trail is
essential:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate audit report for ADSL</span></span>
<span><span class="va">audit_report</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/list_table_snapshots.html">list_table_snapshots</a></span><span class="op">(</span><span class="st">"adsl"</span><span class="op">)</span></span>
<span><span class="va">audit_report</span></span>
<span><span class="co">#&gt;    snapshot_id       snapshot_time schema_version</span></span>
<span><span class="co">#&gt; 16          15 2026-02-09 21:16:42             15</span></span>
<span><span class="co">#&gt; 22          21 2026-02-09 21:16:45             21</span></span>
<span><span class="co">#&gt; 23          22 2026-02-09 21:16:45             22</span></span>
<span><span class="co">#&gt; 24          23 2026-02-09 21:16:45             23</span></span>
<span><span class="co">#&gt; 25          24 2026-02-09 21:16:46             24</span></span>
<span><span class="co">#&gt; 26          25 2026-02-09 21:16:46             25</span></span>
<span><span class="co">#&gt;                                                                                       changes</span></span>
<span><span class="co">#&gt; 16                                        tables_created, tables_inserted_into, main.adsl, 15</span></span>
<span><span class="co">#&gt; 22                    tables_created, tables_dropped, tables_inserted_into, main.adsl, 15, 21</span></span>
<span><span class="co">#&gt; 23                    tables_created, tables_dropped, tables_inserted_into, main.adsl, 21, 22</span></span>
<span><span class="co">#&gt; 24                    tables_created, tables_dropped, tables_inserted_into, main.adsl, 22, 23</span></span>
<span><span class="co">#&gt; 25                    tables_created, tables_dropped, tables_inserted_into, main.adsl, 23, 24</span></span>
<span><span class="co">#&gt; 26 tables_created, tables_dropped, tables_inserted_into, main.adsl, main.adae, 16, 24, 25, 26</span></span>
<span><span class="co">#&gt;     author              commit_message</span></span>
<span><span class="co">#&gt; 16 T Gerke         Create ADSL dataset</span></span>
<span><span class="co">#&gt; 22 T Gerke Add age categorization vars</span></span>
<span><span class="co">#&gt; 23 T Gerke      Test age categories v1</span></span>
<span><span class="co">#&gt; 24 T Gerke    Refine age categories v2</span></span>
<span><span class="co">#&gt; 25 T Gerke     Finalize age categories</span></span>
<span><span class="co">#&gt; 26 T Gerke           Add analysis flag</span></span>
<span><span class="co">#&gt;                                                                      commit_extra_info</span></span>
<span><span class="co">#&gt; 16 Derived from DM, SUPPDM, DS, EX; includes treatment dates, safety flags, age groups</span></span>
<span><span class="co">#&gt; 22                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 23                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 24                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 25                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 26                                                                                &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Get table metadata from DuckLake system tables</span></span>
<span><span class="va">adsl_table_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_metadata_table.html">get_metadata_table</a></span><span class="op">(</span><span class="st">"ducklake_table"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">table_name</span> <span class="op">==</span> <span class="st">"adsl"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">adsl_table_meta</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">#&gt;   table_id table_uuid     begin_snapshot end_snapshot schema_id table_name path </span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       15 019c4443-8a3f…             15           21         0 adsl       adsl/</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>       21 019c4443-9524…             21           22         0 adsl       adsl/</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>       22 019c4443-95f5…             22           23         0 adsl       adsl/</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>       23 019c4443-96a7…             23           24         0 adsl       adsl/</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>       24 019c4443-975a…             24           25         0 adsl       adsl/</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>       26 019c4443-9904…             25           <span style="color: #BB0000;">NA</span>         0 adsl       adsl/</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: path_is_relative &lt;lgl&gt;</span></span></span>
<span></span>
<span><span class="co"># Export audit information</span></span>
<span><span class="va">audit_export</span> <span class="op">&lt;-</span> <span class="va">audit_report</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    table_name <span class="op">=</span> <span class="st">"adsl"</span>,</span>
<span>    dataset_label <span class="op">=</span> <span class="st">"Subject-Level Analysis Dataset"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">audit_export</span></span>
<span><span class="co">#&gt;    snapshot_id       snapshot_time schema_version</span></span>
<span><span class="co">#&gt; 16          15 2026-02-09 21:16:42             15</span></span>
<span><span class="co">#&gt; 22          21 2026-02-09 21:16:45             21</span></span>
<span><span class="co">#&gt; 23          22 2026-02-09 21:16:45             22</span></span>
<span><span class="co">#&gt; 24          23 2026-02-09 21:16:45             23</span></span>
<span><span class="co">#&gt; 25          24 2026-02-09 21:16:46             24</span></span>
<span><span class="co">#&gt; 26          25 2026-02-09 21:16:46             25</span></span>
<span><span class="co">#&gt;                                                                                       changes</span></span>
<span><span class="co">#&gt; 16                                        tables_created, tables_inserted_into, main.adsl, 15</span></span>
<span><span class="co">#&gt; 22                    tables_created, tables_dropped, tables_inserted_into, main.adsl, 15, 21</span></span>
<span><span class="co">#&gt; 23                    tables_created, tables_dropped, tables_inserted_into, main.adsl, 21, 22</span></span>
<span><span class="co">#&gt; 24                    tables_created, tables_dropped, tables_inserted_into, main.adsl, 22, 23</span></span>
<span><span class="co">#&gt; 25                    tables_created, tables_dropped, tables_inserted_into, main.adsl, 23, 24</span></span>
<span><span class="co">#&gt; 26 tables_created, tables_dropped, tables_inserted_into, main.adsl, main.adae, 16, 24, 25, 26</span></span>
<span><span class="co">#&gt;     author              commit_message</span></span>
<span><span class="co">#&gt; 16 T Gerke         Create ADSL dataset</span></span>
<span><span class="co">#&gt; 22 T Gerke Add age categorization vars</span></span>
<span><span class="co">#&gt; 23 T Gerke      Test age categories v1</span></span>
<span><span class="co">#&gt; 24 T Gerke    Refine age categories v2</span></span>
<span><span class="co">#&gt; 25 T Gerke     Finalize age categories</span></span>
<span><span class="co">#&gt; 26 T Gerke           Add analysis flag</span></span>
<span><span class="co">#&gt;                                                                      commit_extra_info</span></span>
<span><span class="co">#&gt; 16 Derived from DM, SUPPDM, DS, EX; includes treatment dates, safety flags, age groups</span></span>
<span><span class="co">#&gt; 22                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 23                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 24                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 25                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 26                                                                                &lt;NA&gt;</span></span>
<span><span class="co">#&gt;    table_name                  dataset_label</span></span>
<span><span class="co">#&gt; 16       adsl Subject-Level Analysis Dataset</span></span>
<span><span class="co">#&gt; 22       adsl Subject-Level Analysis Dataset</span></span>
<span><span class="co">#&gt; 23       adsl Subject-Level Analysis Dataset</span></span>
<span><span class="co">#&gt; 24       adsl Subject-Level Analysis Dataset</span></span>
<span><span class="co">#&gt; 25       adsl Subject-Level Analysis Dataset</span></span>
<span><span class="co">#&gt; 26       adsl Subject-Level Analysis Dataset</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cleanup">Cleanup<a class="anchor" aria-label="anchor" href="#cleanup"></a>
</h2>
<p>When you’re done, you can detach from the data lake:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/detach_ducklake.html">detach_ducklake</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette demonstrated how <strong>ducklake</strong> provides a
robust infrastructure for clinical trial data management:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Setup</strong>: Created a versioned data lake for clinical
trial data</li>
<li>
<strong>Medallion Architecture</strong>: Implemented bronze (raw),
silver (cleaned), and gold (analysis) layers</li>
<li>
<strong>SDTM Loading</strong>: Loaded multiple SDTM domains in both
raw and cleaned versions with full version control</li>
<li>
<strong>ADaM Derivation</strong>: Built analysis datasets (ADSL,
ADAE, ADPC) with complete data lineage from silver to gold</li>
<li>
<strong>Regulatory Artifacts</strong>: Stored define.xml, ARD, ARM,
and specifications alongside datasets</li>
<li>
<strong>Organization</strong>: Maintained cohesive relationships
between related datasets and documentation</li>
<li>
<strong>Functionality</strong>: Demonstrated versioning, time
travel, transactions, and record updates</li>
<li>
<strong>Analysis</strong>: Showed efficient cross-domain
queries</li>
<li>
<strong>Compliance</strong>: Generated audit trails for regulatory
requirements with raw data preservation</li>
</ol>
<p>By using ducklake for clinical trial data, you ensure:</p>
<ul>
<li>
<strong>Modern Architecture</strong>: Relational database structure
for inherently relational CDISC data</li>
<li>
<strong>Layered Design</strong>: Bronze/silver/gold layers separate
raw, cleaned, and analysis-ready data</li>
<li>
<strong>Reproducibility</strong>: Analyses can be exactly recreated;
raw data enables reprocessing</li>
<li>
<strong>Traceability</strong>: Complete lineage from raw source
through cleaning to final analysis</li>
<li>
<strong>Collaboration</strong>: Multiple analysts working safely
with shared data layers</li>
<li>
<strong>Compliance</strong>: Regulatory-ready audit trails with
preserved source data</li>
<li>
<strong>Efficiency</strong>: Fast queries across related datasets
without loading multiple flat files</li>
<li>
<strong>Data Integrity</strong>: Referential integrity checks across
related tables</li>
<li>
<strong>Reprocessability</strong>: Ability to rerun cleaning or
analysis logic without re-extracting from EDC</li>
</ul>
<p>For more information on specific features:</p>
<ul>
<li>
<code><a href="../articles/ducklake.html">vignette("ducklake")</a></code> - Getting started guide</li>
<li>
<code><a href="../articles/time-travel.html">vignette("time-travel")</a></code> - Time travel and version
control</li>
<li>
<code><a href="../articles/transactions.html">vignette("transactions")</a></code> - Transaction management</li>
</ul>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li><a href="https://www.cdisc.org/standards/foundational/sdtm" class="external-link">CDISC
SDTM</a></li>
<li><a href="https://www.cdisc.org/standards/foundational/adam" class="external-link">CDISC
ADaM</a></li>
<li><a href="https://pharmaverse.org/" class="external-link">pharmaverse</a></li>
<li><a href="https://pharmaverse.github.io/admiral/" class="external-link">admiral</a></li>
<li><a href="https://pharmaverse.github.io/pharmaversesdtm/" class="external-link">pharmaversesdtm</a></li>
<li><a href="https://ducklake.select/docs/stable/" class="external-link">DuckLake
Documentation</a></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Travis Gerke.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
